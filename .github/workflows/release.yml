name: "Manual Tauri Release"

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Git Tag for the Release (e.g., v1.0.0)"
        required: true
        type: string
      release_name:
        description: "Release title (e.g., App Name v1.0.0)"
        required: true
        type: string
      release_type:
        description: "Type of release (draft, private, public)"
        required: true
        type: choice
        options:
          - draft
          - private
          - public
      release_notes:
        description: "Release notes"
        required: false

# FIX: Set contents: write permission at the workflow level for maximum reliability,
permissions:
  contents: write

jobs:
  # 1. Gets the application version and ensures Node/Rust setup are complete.
  # We do NOT create the release here anymore.
  setup:
    runs-on: ubuntu-latest
    outputs:
      app_version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Get App Version
        id: get_version
        run: |
          # Extract version from package.json for consistent naming
          APP_VERSION=$(node -p "require('./package.json').version")
          echo "version=$APP_VERSION" >> $GITHUB_OUTPUT

  # 2. Build for all platforms concurrently AND upload assets directly to the release.
  build:
    name: Build for ${{ matrix.os }} and Upload Assets
    needs: setup
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # Do not cancel other builds if one fails
      matrix:
        os: [ubuntu-22.04, macos-latest, windows-latest] 
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install Python dependencies
        run: pip install fastapi uvicorn pydantic

      - name: Install pnpm and JS dependencies
        run: |
          corepack enable
          corepack prepare pnpm@9.15.4 --activate
          pnpm install
          
      - name: Install sidecar Python requirements
        run: pnpm install-reqs 

      - name: Install system dependencies for Linux
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
          
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.os == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}
          
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Build icons
        run: pnpm build:icons

      - name: Run Sidecar Pre-Build Scripts
        run: |
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            pnpm build:sidecar-linux
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            pnpm build:sidecar-macos
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            pnpm build:sidecar-winos
          fi
          
      # CRITICAL FIX: Use the tauri-action to create the release and upload assets directly.
      - name: Build Tauri App and Create Release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Use inputs directly from workflow_dispatch
          tagName: ${{ github.event.inputs.tag_name }}
          releaseName: ${{ github.event.inputs.release_name }}
          releaseBody: ${{ github.event.inputs.release_notes }}
          prerelease: ${{ github.event.inputs.release_type == 'private' }}
          draft: ${{ github.event.inputs.release_type == 'draft' }}
          # The action builds and uploads the assets to the release in one go.
          uploadWorkflowArtifacts: false # Do not upload temporary artifacts
